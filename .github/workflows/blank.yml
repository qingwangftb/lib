name: Build FFmpeg 4.3 for Windows x64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout (empty repo)
      uses: actions/checkout@v4

    - name: Install MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          git
          unzip
          make
          yasm
          pkg-config
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-pkg-config

    - name: Build FFmpeg 4.3
      shell: msys2 {0}
      run: |
        pacman -Sy --noconfirm
        mkdir -p /c/build && cd /c/build
        git clone --branch release/4.3 https://github.com/FFmpeg/FFmpeg ffmpeg
        cd ffmpeg
        ./configure \
          --prefix=/c/build/ffmpeg_build \
          --toolchain=msvc \
          --arch=x86_64 \
          --target-os=win64 \
          --enable-static \
          --disable-shared \
          --disable-debug \
          --disable-doc \
          --disable-programs \
          --disable-avdevice \
          --disable-swscale \
          --disable-postproc \
          --enable-avcodec \
          --enable-avutil \
          --enable-swresample
        make -j$(nproc)
        make install

    - name: Package Artifacts
      shell: bash
      run: |
        cd /c/build/ffmpeg_build
        zip -r ffmpeg-libs-x64-static.zip include lib

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-4.3-static-x64
        path: /c/build/ffmpeg_build/ffmpeg-libs-x64-static.zip
